<script>
function el(id){ return document.getElementById(id); }

let currentMode="";
const fixedUnits="الامــن الــعـام + امـن الـطـرق + المهام والواجبات الخاصه";

const supervisionRanks=["عميد ركن","عقيد ركن","مقدم ركن","رائد","نقيب","ملازم اول","ملازم"];
const zoneRanks=["رئيس رقباء","رقيب اول","رقيب"];
const allRanks=["عميد ركن","عقيد ركن","مقدم ركن","رائد","نقيب","ملازم اول","ملازم","رئيس رقباء","رقيب اول","رقيب"];

// التوجيهات للمنطقة
const zoneTasks={
  "سين 10":"ساندي",
  "سين 20":"ساندي",
  "باء 10":"بوليتو",
  "باء 20":"جزيره بوليتو",
  "لام 10":"لام",
  "جيم 10":"جيم",
  "دال 10":"دال"
};

// التوجيهات للإشراف
const supervisionTasks={
  "سهم 1":"ساندي + بوليتو",
  "سهم 2":"ساندي + بوليتو",
  "سهم 3":"ساندي + بوليتو",
  "سهم 4":"ساندي + بوليتو",
  "سهم 5":"ساندي + بوليتو",
  "درع 1":"ساندي + بوليتو",
  "درع 2":"ساندي + بوليتو",
  "درع 3":"ساندي + بوليتو",
  "درع 4":"ساندي + بوليتو",
  "درع 5":"ساندي + بوليتو",
  "جنوب 1":"ساندي",
  "جنوب 2":"ساندي",
  "جنوب 3":"ساندي",
  "جنوب 4":"ساندي",
  "غرب 1":"بوليتو",
  "غرب 2":"بوليتو",
  "غرب 3":"بوليتو",
  "غرب 4":"بوليتو",
  "ساهر 1":"جيم + لام",
  "ساهر 2":"جيم + لام",
  "ساهر 3":"دال",
  "ساهر 4":"دال",
  "رصد":"جيم + لام + دال",
  "سيف":"جيم + لام + دال"
};

// الدورات
const courseTasks={
  "شرطة عسكرية":"ساندي + بوليتو + لوس",
  "الشؤون الادارية":"ساندي + بوليتو + لوس",
  "نقل سجون":"ساندي + بوليتو + لوس",
  "S.W.A.T":"ساندي + بوليتو + لوس",
  "البحث الجنائي":"ساندي + بوليتو + لوس",
  "المهام والواجبات الخاصة":"ساندي + بوليتو + لوس",
  "مكافحة المخدرات":"ساندي + بوليتو + لوس",
  "الدعم الجوي":"ساندي + بوليتو + لوس",
  "شعبة المرور":"ساندي + بوليتو + لوس",
  "خدمات الطرق":"ساندي + بوليتو + لوس"
};

// وقت السعودية
function getSaudiTime(){
  const now=new Date();
  const utc=now.getTime()+now.getTimezoneOffset()*60000;
  return new Date(utc+3*3600000);
}

function initRankOptions(ranks){
  const r=el("rank");
  if(!r) return;
  r.innerHTML='<option disabled selected>اختر الرتبة</option>';
  ranks.forEach(x=>r.innerHTML+=`<option>${x}</option>`);
}

function openForm(type){
  currentMode=type;

  if(el("menu-section")) el("menu-section").style.display="none";
  if(el("form-section")) el("form-section").style.display="block";

  if(el("taskName")) el("taskName").value="";
  if(el("location")) el("location").value="";
  if(el("copyID")) el("copyID").value="";
  if(el("units")) el("units").value="";
  if(el("courseName")) el("courseName").value="";

  initRankOptions(
    currentMode==="supervision" ? supervisionRanks :
    (currentMode==="zone" ? zoneRanks : allRanks)
  );

  if(el("earlySelect")) el("earlySelect").value="no";
  toggleEarlyReason();

  if(el("unitGroup"))
    el("unitGroup").style.display=(currentMode==="zone")?"block":"none";

  if(el("courseGroup"))
    el("courseGroup").style.display=(currentMode==="courses")?"block":"none";

  if(currentMode==="courses" && el("courseName")){
    el("courseName").onchange=function(){
      if(el("location"))
        el("location").value=courseTasks[this.value]||"";
    };
  }
}

function toggleEarlyReason(){
  if(!el("earlySelect")||!el("earlyReasonGroup")) return;
  el("earlyReasonGroup").style.display=
    el("earlySelect").value==="yes"?"block":"none";
}

function goBack(){
  if(el("menu-section")) el("menu-section").style.display="block";
  if(el("form-section")) el("form-section").style.display="none";
}

function countWords(text){
  return text.trim().split(/\s+/).filter(w=>w.length>0).length;
}

function copyReport(){
  const task=el("taskName")?.value||"...";
  const loc=el("location")?.value||"...";
  const rank=el("rank")?.value||"...";
  const copyID=el("copyID")?.value||"1205646094915084300";
  const early=el("earlySelect")?.value==="yes"?el("earlyReason")?.value:null;

  let unitsText="";
  if(currentMode==="zone" && el("units")){
    if(countWords(el("units").value)>400){
      alert("الوحدات التابعة يجب ألا تتجاوز 400 كلمة");
      return;
    }
    unitsText=el("units").value;
  }

  const endTime=getSaudiTime();
  const startTime=new Date(endTime.getTime()-60*60000);

  function formatTime(d){
    let h=d.getHours()%12||12;
    let m=d.getMinutes();
    let p=d.getHours()>=12?"م":"ص";
    return `${h<10?"0"+h:h}:${m<10?"0"+m:m} ${p}`;
  }

  let report="";

  if(currentMode==="supervision"){
    report=`** \`تـم اسـتـلام مـهـام ( ${task} ) من السـاعة ${formatTime(startTime)} اٍلـى الـساعة ${formatTime(endTime)}\` **

** \`الـمـنـطـقـة : ${loc}\` **

** \`الـجــهــات الامــنـيــة المــتــواجــده :\` **
** \`${fixedUnits}\` **

** \`تم رفـــع التـقـريـر من قبــل ( ${rank} ) :\` ** <@${copyID}>`;
  }
  else if(currentMode==="zone"){
    report=`** \`تـم اسـتـلام مـهـام ( ${task} ) من السـاعة ${formatTime(startTime)} اٍلـى الـساعة ${formatTime(endTime)}\` **

** \`الـمـنـطـقـة : ${loc}\` **

** \`الوحدات التابعة :\` **
** \`${unitsText}\` **

** \`تم رفـــع التـقـريـر من قبــل ( ${rank} ) :\` ** <@${copyID}>`;
  }
  else if(currentMode==="courses"){
    const courseName=el("courseName")?.value||"...";
    report=`\`تم استلام مهام ( ${task} ) من الساعة ${formatTime(startTime)} إلى ${formatTime(endTime)}\`

الموقع : \`${loc}\`

اسم الدورة : \`${courseName}\`

\`\`تم رفع التقرير من قبل ( ${rank} )\`\` : <@${copyID}>`;
  }

  if(early) report+=`\n** \`سبب التبكير : ${early}\` **`;

  navigator.clipboard.writeText(report);
  alert("تم نسخ التقرير ✅");
}

// تقارير العمليات
function openOperationsReports(){
  window.location.href="https://1boletop.netlify.app/";
}
</script>
